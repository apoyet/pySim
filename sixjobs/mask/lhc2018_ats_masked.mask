option, -echo, -warn;
call, file="%MASKED_seqPath";
call, file="/afs/cern.ch/user/a/apoyet/public/pySim/macro/macro_bb.madx";
call, file="/afs/cern.ch/user/a/apoyet/public/pySim/macro/wires_installation.madx";
call, file="/afs/cern.ch/user/a/apoyet/public/pySim/macro/footprint.madx"
option, echo, warn;


qx_tar = 62.31;
qy_tar = 60.32;

! FOR BEAM 1

use, sequence=lhcb1;
twiss;



! want to install @ 158.3 m from the IP

!s_opt = 158.3;

! IP5

sIP5 = table(twiss, ip5, s);

x_wire_r5.b1 = %MASKED_x_wire_r5;
y_wire_r5.b1 = %MASKED_y_wire_r5;
s_wire_r5.b1 = sIP5+%MASKED_s_wire_r5;
I_wire_r5.b1 = %MASKED_I_wire_r5;
r_wire_r5.b1 = SQRT(x_wire_r5.b1^2 + y_wire_r5.b1^2);

x_wire_l5.b1 = %MASKED_x_wire_l5;
y_wire_l5.b1 = %MASKED_y_wire_l5;
s_wire_l5.b1 = sIP5-%MASKED_s_wire_l5;
I_wire_l5.b1 = %MASKED_I_wire_l5;
r_wire_l5.b1 = SQRT(x_wire_l5.b1^2 + y_wire_l5.b1^2);

if(I_wire_r5.b1<>0){
dk4_r5 = 7.79838596e-10 + 8.66179168e-12*I_wire_r5.b1/r_wire_r5.b1^2 - 2.43268741e-20*(I_wire_r5.b1/r_wire_r5.b1^2)^2 + 3.52561927e-28*(I_wire_r5.b1/r_wire_r5.b1^2)^3;
dk5_r5 = -7.55033345e-09 - 8.91143947e-12*I_wire_r5.b1/r_wire_r5.b1^2 + 4.70617718e-20*(I_wire_r5.b1/r_wire_r5.b1^2)^2 - 4.72438536e-28*(I_wire_r5.b1/r_wire_r5.b1^2)^3;
kq5.r5b1 = kq5.r5b1 + dk5_r5;
kq4.r5b1 = kq4.r5b1 + dk4_r5;
exec, INSTALL_WIRE_C_B1(bbwire_c_r5.b1, s_wire_r5.b1, x_wire_r5.b1, y_wire_r5.b1, I_wire_r5.b1);
};

if(I_wire_l5.b1<>0){
dk4_l5 = -9.44637723e-09 + 8.99707154e-12*I_wire_l5.b1/r_wire_l5.b1^2 + 3.95637465e-20*(I_wire_l5.b1/r_wire_l5.b1^2)^2 + 1.54600609e-27*(I_wire_l5.b1/r_wire_l5.b1^2)^3;
dk5_l5 = 6.59444118e-09 - 9.43833110e-12*I_wire_l5.b1/r_wire_l5.b1^2 - 7.90351827e-20*(I_wire_l5.b1/r_wire_l5.b1^2)^2 - 3.46130060e-28*(I_wire_l5.b1/r_wire_l5.b1^2)^3;
kq5.l5b1 = kq5.l5b1 + dk5_l5;
kq4.l5b1 = kq4.l5b1 + dk4_l5;
exec, INSTALL_WIRE_C_B1(bbwire_c_l5.b1, s_wire_l5.b1, x_wire_l5.b1, y_wire_l5.b1, I_wire_l5.b1);
};

! IP1

sIP1 = table(twiss, ip1, s);

x_wire_r1.b1 = %MASKED_x_wire_r1;
y_wire_r1.b1 = %MASKED_y_wire_r1;
s_wire_r1.b1 = sIP1+%MASKED_s_wire_r1;
I_wire_r1.b1 = %MASKED_I_wire_r1;
r_wire_r1.b1 = SQRT(x_wire_r1.b1^2 + y_wire_r1.b1^2);

x_wire_l1.b1 = %MASKED_x_wire_l1;
y_wire_l1.b1 = %MASKED_y_wire_l1;
s_wire_l1.b1 = sIP1-%MASKED_s_wire_l1;
I_wire_l1.b1 = %MASKED_I_wire_l1;
r_wire_l1.b1 = SQRT(x_wire_l1.b1^2 + y_wire_l1.b1^2);

if(I_wire_r1.b1<>0){
dk4_r1 = -2.65998341e-10 - 8.88991568e-12*I_wire_r1.b1/r_wire_r1.b1^2 - 1.96649614e-20*(I_wire_r1.b1/r_wire_r1.b1^2)^2 - 8.45114760e-28*(I_wire_r1.b1/r_wire_r1.b1^2)^3;
dk5_r1 = -7.55037152e-09 + 9.28493511e-12*I_wire_r1.b1/r_wire_r1.b1^2 + 4.52889677e-20*(I_wire_r1.b1/r_wire_r1.b1^2)^2 + 1.29847718e-27*(I_wire_r1.b1/r_wire_r1.b1^2)^3;
kq5.r1b1 = kq5.r1b1 + dk5_r1;
kq4.r1b1 = kq4.r1b1 + dk4_r1;
exec, INSTALL_WIRE_C_B1(bbwire_c_r1.b1, s_wire_r1.b1, x_wire_r1.b1, y_wire_r1.b1, I_wire_r1.b1);
};

if(I_wire_l1.b1<>0){          
dk4_l1 = -1.07126941e-08 - 8.79548867e-12*I_wire_l1.b1/r_wire_l1.b1^2 + 3.60883837e-20*(I_wire_l1.b1/r_wire_l1.b1^2)^2 - 1.04640821e-28*(I_wire_l1.b1/r_wire_l1.b1^2)^3;
dk5_l1 = 8.57607570e-09 + 9.13091672e-12*I_wire_l1.b1/r_wire_l1.b1^2 - 6.73915860e-20*(I_wire_l1.b1/r_wire_l1.b1^2)^2 + 1.17667046e-27*(I_wire_l1.b1/r_wire_l1.b1^2)^3;
kq5.l1b1 = kq5.l1b1 + dk5_l1;
kq4.l1b1 = kq4.l1b1 + dk4_l1;
exec, INSTALL_WIRE_C_B1(bbwire_c_l1.b1, s_wire_l1.b1, x_wire_l1.b1, y_wire_l1.b1, I_wire_l1.b1);
};

ON_BB_CHARGE := 1;

VRF400:=12.;
LAGRF400.B1=0.5;
LAGRF400.B2=0.;

use,sequence=lhcb1;
twiss;
xnom1=table(twiss,IP1,x);pxnom1=table(twiss,IP1,px);ynom1=table(twiss,IP1,y);pynom1=table(twiss,IP1,py);
xnom2=table(twiss,IP2,x);pxnom2=table(twiss,IP2,px);ynom2=table(twiss,IP2,y);pynom2=table(twiss,IP2,py);
xnom5=table(twiss,IP5,x);pxnom5=table(twiss,IP5,px);ynom5=table(twiss,IP5,y);pynom5=table(twiss,IP5,py);
xnom8=table(twiss,IP8,x);pxnom8=table(twiss,IP8,px);ynom8=table(twiss,IP8,y);pynom8=table(twiss,IP8,py);
betxnom1 =table(twiss,IP1,betx) ;betynom1 = table(twiss,IP1,bety) ;
betxnom5 =table(twiss,IP5,betx) ;betynom5 = table(twiss,IP5,bety) ;

dtct1b1=table(twiss,TCTPH.4L1.B1,mux)-table(twiss,MKD.O5L6.B1,mux);
dtct5b1=table(twiss,TCTPH.4L5.B1,mux)-table(twiss,MKD.O5L6.B1,mux)+table(summ,q1);
ddtct1b1=(dtct1b1-floor(dtct1b1))*360;
ddtct5b1=(dtct5b1-floor(dtct5b1))*360;
value,dtct1b1,dtct5b1,ddtct1b1,ddtct5b1;

value,xnom1,xnom2,xnom5,xnom8;
value,ynom1,ynom2,ynom5,ynom8;
value,pxnom1,pxnom2,pxnom5,pxnom8;
value,pynom1,pynom2,pynom5,pynom8;
value, betxnom1,betynom1,betxnom5,betynom5;
value, table(summ,q1);
value, table(summ,q2);
value, table(summ,dq1);
value, table(summ,dq2);

! Printout the WIRE LENSES
if (ON_WIRE==1){
exec, PRINT_WIRE_LENSES;
};

sixtrack,cavall, radius=0.017;

!Fix bb lenses in sixtrack input
exec, SIXTRACK_INPUT_BB_LENSES;

select, flag=twiss, clear;
if (not_a_mask==1){
twiss,file="last_twiss.1";
System,"gzip -f last_twiss.1";
} else {
twiss,file="last_twiss.%SEEDRAN";
System,"gzip -f last_twiss.%SEEDRAN";
};


stop;
